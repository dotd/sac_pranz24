import numpy as np
import gym
from gym import Wrapper
from torch.utils.tensorboard import SummaryWriter

from simplified_vae.config.config import BaseConfig


class FixedToggleSwimmerWindVelWrapper(Wrapper):

    def __init__(self,
                 env: gym.Env,
                 config: BaseConfig,
                 logger: SummaryWriter):

        super(FixedToggleSwimmerWindVelWrapper, self).__init__(env)

        self.config: BaseConfig = config
        self.logger: SummaryWriter = logger

        self.action_dim: int = self.env.action_space.shape[0]
        self.counter: int = 0

        self._max_episode_steps: int = 500

        self.task_idx: int = 0
        self.tasks = [np.array([0.16308017, 19.30782]), np.array([1.8980728, 5.800347])]

        self.increments_counter = 0
        # self.time_increments = [3385, 6726, 9980, 13209, 16480, 19731, 23083, 26318, 29582, 32869, 36306, 39575, 42807,
        #                         46147, 49442, 52670, 56109, 59713, 63078, 66509, 69745, 73075, 76502, 79816, 83079,
        #                         86289, 89545, 92838, 96280, 99818, 103082, 106481, 109711, 113073, 116352, 119553,
        #                         122879, 126129, 129502, 132811, 136011, 139278, 142679, 145906, 149145, 152548,
        #                         155769, 159052, 162279, 165820, 169181, 172440, 175648, 178886, 182156,185624,
        #                         188835, 192114, 195435, 198713, 202080, 205357, 208887, 212178, 215466, 218724,
        #                         222014, 225262, 228547, 231781, 235001, 238221, 241515, 244821, 248085, 251294,
        #                         254635, 258043, 261498, 264881, 268308, 271763, 275040, 278289, 281610, 284842,
        #                         288208, 291596, 295020, 298308, 301805, 305091, 308350, 311657, 315413, 318860,
        #                         322216, 325424, 328718, 331984, 335282, 338667, 341894, 345224, 348436, 351660,
        #                         355017, 358257, 361625, 364835, 368050, 371369, 374573, 377857,  381296, 384572,
        #                         387885, 391087, 394387, 397679, 400964, 404213, 407458, 411049, 414252, 417454, 420976,
        #                         424196, 427409, 430632, 433992, 437467, 440669, 443924, 447134, 450363, 453587, 456890,
        #                         460132, 463351, 466620, 469823, 473033, 476675, 479897, 483141, 486471, 489852, 493301,
        #                         496519, 499830,503368, 506573, 509885, 513270, 516511, 519739, 523029, 526287, 529506,
        #                         532769, 536021, 539304, 542574, 545811, 549054, 552434, 555662, 558943, 562144, 565478,
        #                         568718, 571922, 575154, 578381, 581885, 585128, 588361, 591605, 595097, 598396, 601692,
        #                         605017, 608265, 611518, 614822, 618022, 621243, 624483, 627710, 631010, 634257, 637664,
        #                         640947, 644200, 647451, 650771, 654024, 657331, 660535, 663793, 667022, 670239, 673513,
        #                         676779, 680061, 683401, 686815, 690082, 693319, 696581, 699945, 703351, 706717, 709937,
        #                         713878, 717177, 720385, 723713, 727343, 730594, 733906, 737143, 740366, 743691, 746891,
        #                         750263, 753537, 756747, 759959, 763263, 766668, 769900, 773482, 776692, 780083, 783333,
        #                         786541, 789772, 793032, 796388, 799784, 802998, 806271, 809575, 812817, 816221,
        #                         819453, 822654, 825858, 829171, 832452, 835943, 839420, 842859, 846063, 849400, 852720,
        #                         856025, 859348, 862779, 866080, 869326, 872602, 875825, 879113, 882313, 885529, 888769,
        #                         892124, 895450, 898691, 901987, 905191, 908408, 912007, 915241, 918490, 921769, 925003,
        #                         928267, 931494, 934698, 937917, 941190, 944397, 947648, 950887, 954140, 957350, 960788,
        #                         964051, 967433, 971005, 974246, 977510, 980829, 984084, 987319, 990651, 994074, 997524,
        #                         1000822]

        self.time_increments = [1692, 3363, 4990, 6604, 8240, 9865, 11541, 13159, 14791, 16434,
                                18153, 19787, 21403, 23073, 24721, 26335, 28054, 29856, 31539,
                                33254, 34872, 36537, 38251, 39908, 41539, 43144, 44772, 46419,
                                48140, 49909, 51541, 53240, 54855, 56536, 58176, 59776, 61439,
                                63064, 64751, 66405, 68005, 69639, 71339, 72953, 74572, 76274,
                                77884, 79526, 81139, 82910, 84590, 86220, 87824, 89443, 91078,
                                92812, 94417, 96057, 97717, 99356, 101040, 102678, 104443, 106089,
                                107733, 109362, 111007, 112631, 114273, 115890, 117500, 119110,
                                120757, 122410, 124042, 125647, 127317, 129021, 130749, 132440,
                                134154, 135881, 137520, 139144, 140805, 142421, 144104, 145798,
                                147510, 149154, 150902, 152545, 154175, 155828, 157706, 159430,
                                161108, 162712, 164359, 165992, 167641, 169333, 170947, 172612,
                                174218, 175830, 177508, 179128, 180812, 182417, 184025, 185684,
                                187286, 188928, 190648, 192286, 193942, 195543, 197193, 198839,
                                200482, 202106, 203729, 205524, 207126, 208727, 210488, 212098,
                                213704, 215316, 216996, 218733, 220334, 221962, 223567, 225181,
                                226793, 228445, 230066, 231675, 233310, 234911, 236516, 238337,
                                239948, 241570, 243235, 244926, 246650, 248259, 249915, 251684,
                                253286, 254942, 256635, 258255, 259869, 261514, 263143, 264753,
                                266384, 268010, 269652, 271287, 272905, 274527, 276217, 277831,
                                279471, 281072, 282739, 284359, 285961, 287577, 289190, 290942,
                                292564, 294180, 295802, 297548, 299198, 300846, 302508, 304132,
                                305759, 307411, 309011, 310621, 312241, 313855, 315505, 317128,
                                318832, 320473, 322100, 323725, 325385, 327012, 328665, 330267,
                                331896, 333511, 335119, 336756, 338389, 340030, 341700, 343407,
                                345041, 346659, 348290, 349972, 351675, 353358, 354968, 356939,
                                358588, 360192, 361856, 363671, 365297, 366953, 368571, 370183,
                                371845, 373445, 375131, 376768, 378373, 379979, 381631, 383334,
                                384950, 386741, 388346, 390041, 391666, 393270, 394886, 396516,
                                398194, 399892, 401499, 403135, 404787, 406408, 408110, 409726,
                                411327, 412929, 414585, 416226, 417971, 419710, 421429, 423031,
                                424700, 426360, 428012, 429674, 431389, 433040, 434663, 436301,
                                437912, 439556, 441156, 442764, 444384, 446062, 447725, 449345,
                                450993, 452595, 454204, 456003, 457620, 459245, 460884, 462501,
                                464133, 465747, 467349, 468958, 470595, 472198, 473824, 475443,
                                477070, 478675, 480394, 482025, 483716, 485502, 487123, 488755,
                                490414, 492042, 493659, 495325, 497037, 498762, 500411]

        self.next_change = self.time_increments[self.increments_counter]

        self.ep_length: int = 0
        self.cum_rwd: int = 0

    @property
    def current_task(self):
        return self.tasks[self.task_idx]

    def get_task(self):
        return self.tasks[self.task_idx]

    def get_default_task(self):
        return np.asarray([self.default_target_vel, self.default_wind_frc])

    def set_task(self, task):

        raise NotImplementedError

    def step(self, action):

        if self.counter == self.next_change and self.counter > 0:

            self.increments_counter += 1
            self.next_change = self.time_increments[self.increments_counter]
            self.task_idx = int(not self.task_idx)

            print(f'CHANGED TO TASK {self.current_task} AT STEP {self.counter}!')

            self.logger.add_scalar(tag='env/target_velocity', scalar_value= self.tasks[self.task_idx][0], global_step=self.counter)
            self.logger.add_scalar(tag='env/wind_friction', scalar_value= self.tasks[self.task_idx][1], global_step=self.counter)

        curr_target_vel = self.tasks[self.task_idx][0]
        curr_wind_frec = self.tasks[self.task_idx][1]

        pos_before = self.unwrapped.sim.data.qpos[0]
        force = [0.] * 5 + [curr_wind_frec]

        for part in self.unwrapped.sim.model._body_name2id.values():
            self.unwrapped.sim.data.xfrc_applied[part, :] = force

        next_obs, reward, done, info = self.env.step(action)

        info['task'] = self.tasks[self.task_idx]

        pos_after = self.unwrapped.sim.data.qpos[0]
        forward_vel = (pos_after - pos_before) / self.unwrapped.dt
        reward -= forward_vel  # remove this term
        reward *= 0.5  # to be consistent with varibad and LILAC control costs in HC velocity
        reward += -1 * abs(forward_vel - curr_target_vel)

        self.ep_length += 1
        self.cum_rwd += reward
        if done:
            info['episode'] = dict({})
            info['episode']['l'] = self.ep_length
            info['episode']['r'] = self.cum_rwd
            self.ep_length = self.cum_rwd = 0

        self.counter += 1

        return next_obs, reward, done, info

    def reset(self, **kwargs):
        return self.env.reset(**kwargs)

    def viewer_setup(self):
        self.viewer.cam.distance = self.model.stat.extent * 0.5
        self.viewer.cam.trackbodyid = 0